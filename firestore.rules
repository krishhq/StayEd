rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Safer helper to get user data (returns empty map if document doesn't exist or unauthenticated)
    function getUserData() {
      let path = /databases/$(database)/documents/users/$(request.auth.uid);
      return (request.auth != null && exists(path)) ? get(path).data : {};
    }

    // Check if user is an admin
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    // --- Collection Rules ---
    
    // 1. Users Collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        request.auth.uid == userId ||
        (request.method == 'delete' && resource.data.phone == getUserData().phone)
      );
    }

    // 2. Hostels Collection
    match /hostels/{hostelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (resource == null || resource.data.ownerId == request.auth.uid);
    }

    // 3. Residents Collection
    match /residents/{residentId} {
      allow read: if isAuthenticated() && (
                    (isAdmin() && getUserData().hostelId == resource.data.hostelId) ||
                    (getUserData().role == 'resident' && getUserData().residentId == residentId) ||
                    (getUserData().role == 'guardian' && getUserData().linkedResidentId == residentId)
                  );
      allow write: if isAdmin() && (resource == null || getUserData().hostelId == resource.data.hostelId);
    }

    // 4. Complaints Collection
    match /complaints/{complaintId} {
      allow create: if isAuthenticated() && 
                      getUserData().role == 'resident' &&
                      request.resource.data.hostelId == getUserData().hostelId;
      allow read: if isAuthenticated() && (
        (getUserData().role == 'resident' && (resource.data.residentId == getUserData().residentId || resource.data.residentId == request.auth.uid)) ||
        (isAdmin() && resource.data.hostelId == getUserData().hostelId) ||
        (getUserData().role == 'guardian' && resource.data.hostelId == getUserData().hostelId)
      );
      
      allow update: if isAuthenticated() && 
                      getUserData().role == 'admin' &&
                      resource.data.hostelId == getUserData().hostelId;
      
      allow delete: if false;
    }

    // 5. Attendance & Entry/Exit Logs
    match /attendance/{id} {
      allow create: if isAuthenticated() && getUserData().role == 'resident';
      allow read: if isAuthenticated() && (
        (getUserData().role == 'admin' && getUserData().hostelId == resource.data.hostelId) ||
        (getUserData().role == 'resident' && getUserData().residentId == resource.data.residentId) ||
        (getUserData().role == 'guardian' && getUserData().linkedResidentId == resource.data.residentId)
      );
    }

    match /entry_exit_logs/{id} {
      allow create: if isAuthenticated() && getUserData().role == 'resident';
      allow read: if isAuthenticated() && (
        (getUserData().role == 'admin' && getUserData().hostelId == resource.data.hostelId) ||
        (getUserData().role == 'resident' && getUserData().residentId == resource.data.residentId) ||
        (getUserData().role == 'guardian' && getUserData().linkedResidentId == resource.data.residentId)
      );
    }

    // 6. Leaves Collection
    match /leaves/{id} {
      allow create: if isAuthenticated() && getUserData().role == 'resident';
      allow read: if isAuthenticated() && (
        (getUserData().role == 'admin' && getUserData().hostelId == resource.data.hostelId) ||
        (getUserData().role == 'resident' && getUserData().residentId == resource.data.residentId) ||
        (getUserData().role == 'guardian' && getUserData().linkedResidentId == resource.data.residentId)
      );
      allow update: if isAuthenticated() && (
        (getUserData().role == 'admin' && getUserData().hostelId == resource.data.hostelId) ||
        (getUserData().role == 'guardian' && getUserData().linkedResidentId == resource.data.residentId)
      );
    }

    // 7. Mess Alerts
    match /mess_alerts/{id} {
      allow read: if isAuthenticated() && (
        (getUserData().role == 'admin' && getUserData().hostelId == resource.data.hostelId) ||
        (getUserData().role == 'resident' && getUserData().hostelId == resource.data.hostelId)
      );
      allow write: if isAuthenticated() && getUserData().role == 'admin';
    }

    // 8. Mess Skip Logic
    match /meal_skips/{id} {
      allow create: if isAuthenticated() && getUserData().role == 'resident';
      allow read: if isAuthenticated() && (
        (getUserData().role == 'admin' && getUserData().hostelId == resource.data.hostelId) ||
        (getUserData().role == 'resident' && request.auth.uid == resource.data.userId)
      );
    }

    // 9. Community Forum
    match /forum_posts/{id} {
      allow create: if isAuthenticated() &&
                      request.resource.data.hostelId == getUserData().hostelId &&
                      (
                        (getUserData().role == 'admin' && request.resource.data.postType == 'admin_broadcast') ||
                        (getUserData().role == 'resident' && request.resource.data.postType == 'resident_msg')
                      );
      allow read: if isAuthenticated() &&
                    resource.data.hostelId == getUserData().hostelId &&
                    (
                      getUserData().role == 'resident' || 
                      (getUserData().role == 'admin' && resource.data.postType == 'admin_broadcast')
                    );
      allow update, delete: if false; // Persistent record
    }

    // 10. Emergency Broadcasts
    match /broadcasts/{id} {
      allow create: if isAuthenticated() && 
                      getUserData().role == 'admin' &&
                      request.resource.data.hostelId == getUserData().hostelId;
      allow read: if isAuthenticated() &&
                    resource.data.hostelId == getUserData().hostelId;
      allow update, delete: if false; // Persistent record
    }
  }
}
